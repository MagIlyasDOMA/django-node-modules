import os, glob
from typing import Literal, Optional
from django.template import Library
from django.urls import reverse
from .. import NODE_MODULES_DIR, CACHE_HRENPACK_THEME_STYLE_CONFIG, CACHED_HRENPACK_THEME_STYLE_CONFIG, utils

register = Library()


@register.inclusion_tag('django_node_modules/includes/hrenpack/css.html')
def hrenpack_js_css(version: Optional[str] = None):
    with utils.change_dir(NODE_MODULES_DIR):
        is_local = os.path.isdir(NODE_MODULES_DIR / 'hrenpack_js') and version is not None
        files = glob.glob('*.css')
    if is_local:
        html_context = dict(base_url=reverse('local_node_file', kwargs=dict(path='')),
                            files=files)
    else:
        html_context = dict(base_url=utils.get_local_hrenpack_js_base_url(),
                            files=utils.get_hrenpack_js_files(version or None, files_extension='.css'))
    return html_context


@register.inclusion_tag('django_node_modules/includes/hrenpack_js.html')
def hrenpack_js_scripts(type: Literal['include', 'exclude', 'all'], *args, version: Optional[str] = None):
    html_context = dict(scripts=args, type=type, base_url='', files=list())
    with utils.change_dir(NODE_MODULES_DIR):
        is_local = os.path.isdir(NODE_MODULES_DIR / 'hrenpack_js') and version is not None
        files = glob.glob('*.js')
    if is_local:
        html_context['base_url'] = utils.get_local_hrenpack_js_base_url()
        html_context['files'] = files
    else:
        html_context['base_url'] = utils.get_hrenpack_js_jsdelivr_base_url(version)
        html_context['files'] = utils.get_hrenpack_js_files(version or None)
    return html_context


@register.inclusion_tag('django_node_modules/includes/hrenpack/css.html')
def hrenpack_theme_style_css(config: str, version: Optional[str] = None):
    with utils.change_dir(NODE_MODULES_DIR):
        is_local = os.path.isdir(NODE_MODULES_DIR / 'hrenpack-theme-style') and version is not None
    base_url = utils.get_local_hrenpack_theme_style_base_url() if is_local else utils.get_hrenpack_theme_style_jsdelivr_base_url(version)
    try:
        files = utils.hrenpack_theme_style_config()[config]['css']
    except KeyError:
        raise AttributeError(f"Config {config} not found in hrenpack-theme-style")
    return dict(base_url=base_url, files=files)


@register.inclusion_tag('django_node_modules/includes/hrenpack/hrenpack-theme-style.html')
def hrenpack_theme_style_scripts(config: str, version: Optional[str] = None):
    with utils.change_dir(NODE_MODULES_DIR):
        is_local = os.path.isdir(NODE_MODULES_DIR / 'hrenpack-theme-style') and version is not None
    base_url = utils.get_local_hrenpack_theme_style_base_url() if is_local else utils.get_hrenpack_theme_style_jsdelivr_base_url(version)
    try:
        files = utils.hrenpack_theme_style_config()[config]['js']
    except KeyError:
        raise AttributeError(f"Config {config} not found in hrenpack-theme-style")
    return dict(base_url=base_url, files=files)
