import filetype, os, glob, requests
from typing import Optional
from pathlib import Path
from urllib.parse import urlparse
from contextlib import contextmanager
from django.urls import reverse
from . import NODE_MODULES_DIR, CACHE_HRENPACK_THEME_STYLE_CONFIG, CACHED_HRENPACK_THEME_STYLE_CONFIG, HRENPACK_THEME_STYLE_CONFIG_URL


def remove_protocol_and_domain(url, no_extras: bool = False, return_parsed: bool = False):
    parsed = urlparse(url)
    result = parsed.path
    if not no_extras:
        if parsed.query:
            result += '?' + parsed.query
        if parsed.fragment:
            result += '#' + parsed.fragment
    if return_parsed:
        return parsed
    return result if result else '/'


@contextmanager
def change_dir(destination):
    original_dir = os.getcwd()
    try:
        os.chdir(destination)
        yield
    finally:
        os.chdir(original_dir)


def local_node_file_path(path):
    return NODE_MODULES_DIR / path


def local_node_file(path, **kwargs):
    return open(local_node_file_path(path), **kwargs)


def node_inclusion_context(files: list, type: str, **kwargs):
    return dict(files=files, type=type, **kwargs)


def local_node_package(package_name: str, path: Optional[str] = None, recursive: bool = False,
                       type: Optional[str] = None, **kwargs):
    package_path = NODE_MODULES_DIR / package_name
    with change_dir(package_path):
        files = list()
        path_lst = glob.glob(f'*.{type}', recursive=recursive) if path is None else [path]
        for f in path_lst:
            files.append(reverse('local_node_file',
                                 kwargs=dict(path=os.path.join(package_name, f))))
    return node_inclusion_context(files, type, **kwargs)


def get_hrenpack_js_jsdelivr_base_url(version: Optional[str] = None) -> str:
    return f"https://cdn.jsdelivr.net/npm/hrenpack_js{('@' + version) if version else ''}"


def get_local_hrenpack_js_base_url() -> str:
    return reverse('local_node_file', kwargs=dict(path='hrenpack_js')).replace('\\', '/').rstrip('/')


def get_package_latest_version(name: str):
    return requests.get(f'https://data.jsdelivr.com/v1/package/npm/{name}').json()['tags']['latest']


def get_hrenpack_js_files(version: Optional[str] = None, without_extension: bool = False, files_extension: str = '.js'):
    if version is None:
        version = get_package_latest_version('hrenpack_js')
    data = requests.get(f'https://data.jsdelivr.com/v1/package/npm/hrenpack_js@{version}/flat').json()
    output = list()
    for file in data['files']:
        name = file['name']
        if name.endswith(files_extension):
            name = name[1:]
            if without_extension:
                name = name[:-4]
            output.append(name)
    return output


def get_hrenpack_theme_style_jsdelivr_base_url(version: Optional[str] = None) -> str:
    return f"https://cdn.jsdelivr.net/npm/hrenpack-theme-style{('@' + version) if version else ''}"


def hrenpack_theme_style_config() -> dict:
    if CACHE_HRENPACK_THEME_STYLE_CONFIG:
        return CACHED_HRENPACK_THEME_STYLE_CONFIG
    return requests.get(HRENPACK_THEME_STYLE_CONFIG_URL).json()


def get_local_hrenpack_theme_style_base_url():
    return reverse('local_node_file', kwargs=dict(path='hrenpack-theme-style')).replace('\\', '/').rstrip('/')
